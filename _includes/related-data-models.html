{% comment %} Show related data models.
  Modes:
  - If the current page has `requires_data_models` (app starter kits) show that explicit list and resolve to site.data_models pages.
  - Otherwise, search `site.data_models` for items that reference this page via `use_cases` or `personas` and show those.
{% endcomment %}

{% if page.requires_data_models and page.requires_data_models.size > 0 %}
  <section class="margin-top-2">
    <h2>Data models</h2>
    <ul class="usa-list" style="list-style: none; margin: 0; padding-left: 0;">
      {% for dm in page.requires_data_models %}
        {% assign dm_item = nil %}
        {% assign dm_lc = dm | downcase %}
        {% for candidate in site.data_models %}
          {% assign cand_slug = candidate.slug | default: '' | downcase %}
          {% assign cand_basename = candidate.basename | default: '' | downcase %}
          {% assign cand_title = candidate.title | default: '' | downcase %}
          {% if cand_slug == dm_lc or cand_basename == dm_lc or cand_title == dm_lc %}
            {% assign dm_item = candidate %}
            {% break %}
          {% endif %}
        {% endfor %}
        {% if dm_item %}
          <li style="display:flex; align-items:center; gap:0.5rem;">
            <span aria-hidden="true" style="display:inline-block; width:1.25rem; text-align:center;">ğŸ—‚ï¸</span>
            <a href="{{ dm_item.url | relative_url }}" class="usa-link">{{ dm_item.title }}</a>
          </li>
        {% else %}
          <li style="display:flex; align-items:center; gap:0.5rem;">
            <span aria-hidden="true" style="display:inline-block; width:1.25rem; text-align:center;">ğŸ—‚ï¸</span>
            <span>{{ dm }}</span>
          </li>
        {% endif %}
      {% endfor %}
    </ul>
  </section>
{% else %}
  {% comment %} Find data models that reference this page via use_cases OR personas {% endcomment %}
  {% assign has_data_models = false %}
  {% for d in site.data_models %}
    {% assign matched = false %}
    {% if d.use_cases %}
      {% for uc in d.use_cases %}
        {% if uc == page.slug or uc == page.basename or uc == page.title %}
          {% assign matched = true %}
          {% break %}
        {% endif %}
      {% endfor %}
    {% endif %}
    {% if d.personas and matched == false %}
      {% for p in d.personas %}
        {% if p == page.title or p == page.slug or p == page.basename %}
          {% assign matched = true %}
          {% break %}
        {% endif %}
      {% endfor %}
    {% endif %}
    {% if matched %}
      {% assign has_data_models = true %}
      {% break %}
    {% endif %}
  {% endfor %}

  {% if has_data_models %}
    <section class="margin-top-4">
      <h2>Related data models</h2>
      <ul class="usa-list" style="list-style: none; margin: 0; padding-left: 0;">
        {% for d in site.data_models %}
          {% assign matched = false %}
          {% if d.use_cases %}
            {% for uc in d.use_cases %}
              {% if uc == page.slug or uc == page.basename or uc == page.title %}
                {% assign matched = true %}
                {% break %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {% if d.personas and matched == false %}
            {% for p in d.personas %}
              {% if p == page.title or p == page.slug or p == page.basename %}
                {% assign matched = true %}
                {% break %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {% if matched %}
            <li style="display:flex; align-items:center; gap:0.5rem;">
              <span aria-hidden="true" style="display:inline-block; width:1.25rem; text-align:center;">ğŸ—‚ï¸</span>
              <a href="{{ d.url | relative_url }}" class="usa-link">{{ d.title }}</a>
            </li>
          {% endif %}
        {% endfor %}
      </ul>
    </section>
  {% endif %}
{% endif %}
