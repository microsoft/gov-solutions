{%- comment -%}
Breadcrumbs include for Jekyll (Gov Solutions docs site) â€” BASEPATH = "/<collection>/" assumption.
Fixed: corrected mismatched Liquid tag (used `endfor` where required).
{%- endcomment -%}

{%- assign BC = site.breadcrumb | default: {} -%}
{%- assign max_depth = BC.max_depth | default: 10 -%}
{%- assign show_home = BC.show_home | default: true -%}
{%- assign link_current = BC.show_current_link | default: false -%}

{%- assign lang = page.lang | default: site.lang | default: 'en' -%}
{%- assign home_text = site.data.i18n[lang].home | default: 'Home' -%}

{%- assign current = include.item | default: page -%}

{%- assign all_items = site.pages -%}
{%- if site.collections -%}
  {%- for coll in site.collections -%}
    {%- assign docs = coll.docs -%}
    {%- if docs == nil -%}
      {%- assign docs = '' | split: '' -%}
    {%- endif -%}
    {%- assign all_items = all_items | concat: docs -%}
  {%- endfor -%}
{%- endif -%}

{%- assign crumb_labels = '' | split: '' -%}
{%- assign crumb_urls = '' | split: '' -%}
{%- assign crumb_linked = '' | split: '' -%}
{%- assign crumb_current = '' | split: '' -%}

{%- assign visited = '' | split: '' -%}
{%- assign walker = current -%}

{%- for _i in (1..max_depth) -%}
  {%- assign visited = visited | push: walker.url -%}
  {%- assign label = walker.title | default: walker.navtitle | default: walker.name | default: walker.displayname | default: walker.slug | default: walker.url -%}
  {%- assign url = walker.url -%}
  {%- assign is_current_page = walker.url == current.url -%}
  {%- assign should_link = true -%}
  {%- if is_current_page and link_current != true -%}
    {%- assign should_link = false -%}
  {%- endif -%}
  {%- assign crumb_labels = crumb_labels | push: label -%}
  {%- assign crumb_urls = crumb_urls | push: url -%}
  {%- assign crumb_linked = crumb_linked | push: should_link -%}
  {%- assign crumb_current = crumb_current | push: is_current_page -%}

  {%- assign next_parent = nil -%}

  {%- if walker.parent_url -%}
    {%- for it in all_items -%}
      {%- if it.url == walker.parent_url or it.permalink == walker.parent_url -%}
        {%- assign next_parent = it -%}
        {%- break -%}
      {%- endif -%}
    {%- endfor -%}
  {%- endif -%}

  {%- if next_parent == nil and walker.parent_id -%}
    {%- for it in all_items -%}
      {%- if it.id and it.id == walker.parent_id -%}
        {%- assign next_parent = it -%}
        {%- break -%}
      {%- endif -%}
    {%- endfor -%}
  {%- endif -%}

  {%- if next_parent == nil and walker.parent -%}
    {%- assign curr_coll = walker.collection | default: 'pages' -%}
    {%- assign curr_meta = site.data.collections[curr_coll] -%}
    {%- if curr_meta == nil -%}
      {%- for c in site.collections -%}
        {%- if c.label == curr_coll and c.metadata -%}
          {%- assign curr_meta = c.metadata -%}
          {%- break -%}
        {%- endif -%}
      {%- endfor -%}
    {%- endif -%}
    {%- if curr_meta and curr_meta.parent_collection -%}
      {%- assign parent_coll = curr_meta.parent_collection -%}
      {%- assign parent_coll_lc = parent_coll | downcase -%}
      {%- assign parent_key = walker.parent | downcase -%}
      {%- assign parent_key_slug = parent_key | replace: ' ', '-' | replace: '_', '-' -%}
{%- for it in all_items -%}
  {%- assign it_coll_label = it.collection -%}
  {%- if it_coll_label and it_coll_label.label -%}
    {%- assign it_coll_label = it_coll_label.label -%}
  {%- endif -%}
  {%- assign it_coll_label = it_coll_label | downcase -%}
  {%- if it_coll_label == parent_coll_lc -%}
    {%- comment %}Build robust comparands for filename/slug/url cases{%- endcomment -%}
    {%- assign candidate = it.slug | default: it.name | default: it.title | default: it.url -%}
    {%- assign candidate_lc = candidate | downcase -%}
    {%- assign candidate_slug = candidate_lc | replace: ' ', '-' | replace: '_', '-' -%}
    {%- assign candidate_base = candidate_slug | remove: '.md' | remove: '.markdown' | remove: '.html' | remove: '/' -%}

    {%- assign url_tail = it.url | split: '/' | last -%}
    {%- assign url_tail = url_tail | downcase | remove: '.html' -%}

    {%- if candidate_base == parent_key_slug -%}
      {%- assign next_parent = it -%}
      {%- break -%}
    {%- endif -%}
    {%- if url_tail == parent_key_slug -%}
      {%- assign next_parent = it -%}
      {%- break -%}
    {%- endif -%}
    {%- if it.id == walker.parent -%}
      {%- assign next_parent = it -%}
      {%- break -%}
    {%- endif -%}
  {%- endif -%}
{%- endfor -%}
    {%- endif -%}
  {%- endif -%}

  {%- if next_parent -%}
    {%- assign walker = next_parent -%}
    {%- if visited contains walker.url -%}
      {%- break -%}
    {%- endif -%}
  {%- else -%}
    {%- assign coll_name = walker.collection | default: 'pages' -%}
    {%- if coll_name == 'pages' -%}
      {%- assign coll_url = '/' -%}
    {%- else -%}
      {%- assign coll_url = '/' | append: coll_name | append: '/' -%}
    {%- endif -%}
    {%- assign coll_label = site.data.collections[coll_name].displayname -%}
    {%- if coll_label == nil or coll_label == '' -%}
      {%- assign coll_label = coll_name | replace: '_', ' ' | replace: '-', ' ' | capitalize -%}
    {%- endif -%}
    {%- unless coll_url == walker.url -%}
      {%- assign crumb_labels = crumb_labels | push: coll_label -%}
      {%- assign crumb_urls = crumb_urls | push: coll_url -%}
      {%- assign crumb_linked = crumb_linked | push: true -%}
      {%- assign crumb_current = crumb_current | push: false -%}
    {%- endunless -%}
    {%- break -%}
  {%- endif -%}
{%- endfor -%}

{%- if show_home and current.url != '/' -%}
  {%- assign home_url = site.baseurl | default: '/' -%}
  {%- assign crumb_labels = crumb_labels | push: home_text -%}
  {%- assign crumb_urls = crumb_urls | push: home_url -%}
  {%- assign crumb_linked = crumb_linked | push: true -%}
  {%- assign crumb_current = crumb_current | push: false -%}
{%- endif -%}

{%- assign labels = crumb_labels | reverse -%}
{%- assign urls = crumb_urls | reverse -%}
{%- assign linked_flags = crumb_linked | reverse -%}
{%- assign current_flags = crumb_current | reverse -%}

<nav aria-label="Breadcrumb" class="usa-breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
  <ol class="usa-breadcrumb__list">
    {%- assign position = 0 -%}
    {%- for label in labels -%}
      {%- assign position = position | plus: 1 -%}
      {%- assign url = urls[forloop.index0] -%}
      {%- assign linked = linked_flags[forloop.index0] -%}
      {%- assign is_current = current_flags[forloop.index0] -%}
      <li class="usa-breadcrumb__list-item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        {%- if linked == true or linked == 'true' -%}
          <a class="usa-breadcrumb__link" itemprop="item" href="{{ url | relative_url }}">
            <span itemprop="name">{{ label }}</span>
          </a>
        {%- else -%}
          <span class="usa-breadcrumb__link" {% if is_current == true or is_current == 'true' %}aria-current="page"{% endif %} itemprop="name">{{ label }}</span>
        {%- endif -%}
        <meta itemprop="position" content="{{ position }}" />
      </li>
    {%- endfor -%}
  </ol>
</nav>
